# Rise Local: Complete Resend Email Setup for Password Reset

## Step 1: Get Your Resend API Key

You've already logged into Resend via GitHub. Now:

1. **Go to:** https://resend.com/api-keys
2. **Click:** "Create API Key"
3. **Name it:** "Rise Local Production" (or whatever you want)
4. **Permissions:** Full access (or just "Sending access" if available)
5. **Copy the API key** - it will look like: `re_123456789abcdefghijklmnop`
6. **IMPORTANT:** Save it somewhere safe - you can only see it once!

---

## Step 2: Add API Key to Replit Environment

**In Replit:**

1. Click the **lock icon** üîí in the left sidebar (or go to "Secrets")
2. Click **"Add new secret"**
3. **Key:** `RESEND_API_KEY`
4. **Value:** Paste your API key (the `re_...` string)
5. Click **"Add secret"**

**Also add your sender email:**

1. Click **"Add new secret"** again
2. **Key:** `EMAIL_FROM`
3. **Value:** `noreply@riselocal.app` (or your verified domain)
4. Click **"Add secret"**

---

## Step 3: Verify Your Domain (Important!)

By default, Resend lets you send from `onboarding@resend.dev` for testing, but for production you need your own domain.

### Option A: Use Your Own Domain (Recommended for Production)

1. **Go to:** https://resend.com/domains
2. **Click:** "Add Domain"
3. **Enter:** `riselocal.app` (your domain)
4. **Follow the instructions** to add DNS records:
   - SPF record
   - DKIM records (usually 2)
   - DMARC record (optional but recommended)
5. **Wait for verification** (usually 5-15 minutes)
6. **Once verified**, you can send from `noreply@riselocal.app`

### Option B: Use Resend's Test Domain (Quick Start/Testing)

For now, you can send from `onboarding@resend.dev` while you set up your domain.

**Set in environment:**
```
EMAIL_FROM=onboarding@resend.dev
```

---

## Step 4: Install Resend Package

**Tell Replit Agent:**

```bash
npm install resend
```

---

## Step 5: Create Email Utility

**Create this file: `server/utils/email.ts` (or `.js` if not using TypeScript)**

```typescript
// server/utils/email.ts
import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);

const FROM_EMAIL = process.env.EMAIL_FROM || 'onboarding@resend.dev';
const APP_NAME = 'Rise Local';

interface SendEmailOptions {
  to: string;
  subject: string;
  html: string;
}

export async function sendEmail({ to, subject, html }: SendEmailOptions) {
  try {
    const data = await resend.emails.send({
      from: `${APP_NAME} <${FROM_EMAIL}>`,
      to: [to],
      subject: subject,
      html: html,
    });

    console.log('Email sent successfully:', data);
    return { success: true, data };
  } catch (error) {
    console.error('Failed to send email:', error);
    return { success: false, error };
  }
}

// Password Reset Email Template
export function generatePasswordResetEmail(firstName: string, resetLink: string) {
  return `
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8">
        <style>
          body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
          }
          .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px 10px 0 0;
            text-align: center;
          }
          .content {
            background: #f9fafb;
            padding: 30px;
            border: 1px solid #e5e7eb;
            border-top: none;
          }
          .button {
            display: inline-block;
            padding: 14px 28px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            margin: 20px 0;
          }
          .footer {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-size: 14px;
          }
          .warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 12px;
            margin: 20px 0;
            border-radius: 4px;
          }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>üîê Reset Your Password</h1>
        </div>
        
        <div class="content">
          <p>Hi ${firstName},</p>
          
          <p>We received a request to reset your password for your Rise Local account.</p>
          
          <p>Click the button below to choose a new password:</p>
          
          <div style="text-align: center;">
            <a href="${resetLink}" class="button">Reset Password</a>
          </div>
          
          <p>Or copy and paste this link into your browser:</p>
          <p style="word-break: break-all; color: #667eea;">${resetLink}</p>
          
          <div class="warning">
            <strong>‚ö†Ô∏è Security Notice:</strong>
            <ul style="margin: 10px 0;">
              <li>This link expires in <strong>1 hour</strong></li>
              <li>If you didn't request this, please ignore this email</li>
              <li>Never share this link with anyone</li>
            </ul>
          </div>
        </div>
        
        <div class="footer">
          <p>Need help? Reply to this email or contact us at support@riselocal.app</p>
          <p style="margin-top: 20px;">
            ¬© ${new Date().getFullYear()} Rise Local. All rights reserved.
          </p>
        </div>
      </body>
    </html>
  `;
}

// Account Recovery Email Template (for users without passwords)
export function generateAccountRecoveryEmail(firstName: string, email: string) {
  return `
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8">
        <style>
          body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
          }
          .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px 10px 0 0;
            text-align: center;
          }
          .content {
            background: #f9fafb;
            padding: 30px;
            border: 1px solid #e5e7eb;
            border-top: none;
          }
          .button {
            display: inline-block;
            padding: 14px 28px;
            background: #10b981;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            margin: 20px 0;
          }
          .info-box {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 16px;
            margin: 20px 0;
            border-radius: 4px;
          }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>üéâ Welcome Back to Rise Local!</h1>
        </div>
        
        <div class="content">
          <p>Hi ${firstName},</p>
          
          <p>We're excited to have you back! Rise Local has upgraded to a new authentication system.</p>
          
          <div class="info-box">
            <strong>üìß Your account email:</strong> ${email}
          </div>
          
          <p>To continue using your account, you'll need to set up a password:</p>
          
          <ol style="line-height: 2;">
            <li>Visit the Rise Local app or website</li>
            <li>Click "Recover Account" on the login page</li>
            <li>Enter your email: <strong>${email}</strong></li>
            <li>Create a secure password</li>
            <li>You're all set! üéä</li>
          </ol>
          
          <p><strong>All your data is safe and waiting for you:</strong></p>
          <ul>
            <li>‚úÖ Your favorite businesses</li>
            <li>‚úÖ Your saved deals</li>
            <li>‚úÖ Your business profile (if you're a vendor)</li>
            <li>‚úÖ Everything else!</li>
          </ul>
          
          <p style="margin-top: 30px;">Need help? We're here for you!</p>
        </div>
        
        <div style="text-align: center; padding: 20px; color: #6b7280; font-size: 14px;">
          <p>Questions? Reply to this email or contact support@riselocal.app</p>
          <p style="margin-top: 20px;">¬© ${new Date().getFullYear()} Rise Local</p>
        </div>
      </body>
    </html>
  `;
}

// Welcome Email Template (after signup)
export function generateWelcomeEmail(firstName: string, isVendor: boolean) {
  return `
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8">
        <style>
          body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
          }
          .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 10px 10px 0 0;
            text-align: center;
          }
          .content {
            background: white;
            padding: 30px;
            border: 1px solid #e5e7eb;
            border-top: none;
          }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>üéâ Welcome to Rise Local!</h1>
        </div>
        
        <div class="content">
          <p>Hi ${firstName},</p>
          
          <p>Thanks for joining Rise Local! We're excited to have you as part of our community supporting local businesses.</p>
          
          ${isVendor ? `
            <h3>üè™ Getting Started as a Vendor</h3>
            <ol style="line-height: 2;">
              <li>Complete your business profile</li>
              <li>Add your first deal</li>
              <li>Start attracting local customers!</li>
            </ol>
          ` : `
            <h3>üí∞ Getting Started</h3>
            <ol style="line-height: 2;">
              <li>Browse local deals in your area</li>
              <li>Save your favorite businesses</li>
              <li>Unlock exclusive offers!</li>
            </ol>
          `}
          
          <p style="margin-top: 30px;">Questions? We're here to help!</p>
        </div>
        
        <div style="text-align: center; padding: 20px; color: #6b7280; font-size: 14px;">
          <p>Reply to this email or contact support@riselocal.app</p>
          <p style="margin-top: 20px;">¬© ${new Date().getFullYear()} Rise Local</p>
        </div>
      </body>
    </html>
  `;
}
```

---

## Step 6: Create Password Reset Endpoints

### Backend: Forgot Password Endpoint

**Create: `server/routes/auth/forgotPassword.ts`**

```typescript
// server/routes/auth/forgotPassword.ts
import { Request, Response } from 'express';
import crypto from 'crypto';
import { db } from '../../config/database';
import { sendEmail, generatePasswordResetEmail } from '../../utils/email';

export async function forgotPassword(req: Request, res: Response) {
  const { email } = req.body;

  if (!email) {
    return res.status(400).json({
      error: 'Email is required',
      code: 'MISSING_EMAIL'
    });
  }

  try {
    // Find user
    const userResult = await db.query(
      'SELECT id, email, firstName FROM users WHERE LOWER(email) = LOWER($1)',
      [email.trim()]
    );

    // SECURITY: Always return success even if user doesn't exist
    // This prevents email enumeration attacks
    if (userResult.rows.length === 0) {
      console.log('Password reset requested for non-existent email:', email);
      return res.json({
        success: true,
        message: 'If an account exists with this email, you will receive a password reset link.'
      });
    }

    const user = userResult.rows[0];

    // Generate reset token
    const resetToken = crypto.randomBytes(32).toString('hex');
    const resetTokenExpiry = new Date(Date.now() + 60 * 60 * 1000); // 1 hour

    // Save token to database
    await db.query(
      'UPDATE users SET resetToken = $1, resetTokenExpiry = $2 WHERE id = $3',
      [resetToken, resetTokenExpiry, user.id]
    );

    // Generate reset link
    const resetLink = `${process.env.FRONTEND_URL}/reset-password?token=${resetToken}`;

    // Send email
    const emailHtml = generatePasswordResetEmail(user.firstName, resetLink);
    
    await sendEmail({
      to: user.email,
      subject: 'Reset Your Rise Local Password',
      html: emailHtml
    });

    console.log('Password reset email sent to:', user.email);

    res.json({
      success: true,
      message: 'If an account exists with this email, you will receive a password reset link.'
    });

  } catch (error) {
    console.error('Forgot password error:', error);
    res.status(500).json({
      error: 'Failed to process password reset request',
      code: 'SERVER_ERROR'
    });
  }
}
```

### Backend: Reset Password Endpoint

**Create: `server/routes/auth/resetPassword.ts`**

```typescript
// server/routes/auth/resetPassword.ts
import { Request, Response } from 'express';
import bcrypt from 'bcrypt';
import { db } from '../../config/database';

export async function resetPassword(req: Request, res: Response) {
  const { token, password } = req.body;

  if (!token || !password) {
    return res.status(400).json({
      error: 'Token and password are required',
      code: 'MISSING_FIELDS'
    });
  }

  // Validate password strength
  if (password.length < 8) {
    return res.status(400).json({
      error: 'Password must be at least 8 characters',
      code: 'PASSWORD_TOO_SHORT'
    });
  }

  try {
    // Find user with valid token
    const userResult = await db.query(
      `SELECT id, email, firstName, resetToken, resetTokenExpiry 
       FROM users 
       WHERE resetToken = $1 AND resetTokenExpiry > NOW()`,
      [token]
    );

    if (userResult.rows.length === 0) {
      return res.status(400).json({
        error: 'Invalid or expired reset token',
        code: 'INVALID_TOKEN'
      });
    }

    const user = userResult.rows[0];

    // Hash new password
    const hashedPassword = await bcrypt.hash(password, 10);

    // Update password and clear reset token
    await db.query(
      `UPDATE users 
       SET password = $1, 
           resetToken = NULL, 
           resetTokenExpiry = NULL,
           failedLoginAttempts = 0,
           lockedUntil = NULL,
           updatedAt = NOW()
       WHERE id = $2`,
      [hashedPassword, user.id]
    );

    console.log('Password reset successful for:', user.email);

    res.json({
      success: true,
      message: 'Password has been reset successfully. You can now log in.'
    });

  } catch (error) {
    console.error('Reset password error:', error);
    res.status(500).json({
      error: 'Failed to reset password',
      code: 'SERVER_ERROR'
    });
  }
}
```

### Add Routes to Your Router

**In `server/routes/index.ts`:**

```typescript
import { forgotPassword } from './auth/forgotPassword';
import { resetPassword } from './auth/resetPassword';

// Add these routes
router.post('/auth/forgot-password', forgotPassword);
router.post('/auth/reset-password', resetPassword);
```

---

## Step 7: Update Database Schema

**Add reset token columns if they don't exist:**

```sql
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS resetToken VARCHAR(255),
ADD COLUMN IF NOT EXISTS resetTokenExpiry TIMESTAMP;

CREATE INDEX IF NOT EXISTS idx_users_reset_token 
ON users(resetToken) 
WHERE resetToken IS NOT NULL;
```

---

## Step 8: Frontend - Forgot Password Page

**Create: `client/src/pages/ForgotPassword.tsx` (or `.jsx`)**

```tsx
// client/src/pages/ForgotPassword.tsx
import { useState } from 'react';
import { Link } from 'react-router-dom';

export default function ForgotPassword() {
  const [email, setEmail] = useState('');
  const [submitted, setSubmitted] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      const response = await fetch('/api/auth/forgot-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });

      const data = await response.json();

      if (response.ok) {
        setSubmitted(true);
      } else {
        setError(data.error || 'Failed to send reset email');
      }
    } catch (err) {
      setError('Network error. Please try again.');
    } finally {
      setLoading(false);
    }
  }

  if (submitted) {
    return (
      <div className="forgot-password-page">
        <div className="success-message">
          <h1>‚úÖ Check Your Email</h1>
          <p>
            If an account exists with <strong>{email}</strong>, you will receive 
            a password reset link shortly.
          </p>
          <p>
            Check your spam folder if you don't see it in a few minutes.
          </p>
          <Link to="/login" className="back-link">
            ‚Üê Back to Login
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="forgot-password-page">
      <div className="forgot-password-container">
        <h1>Reset Your Password</h1>
        <p>Enter your email and we'll send you a reset link.</p>

        <form onSubmit={handleSubmit}>
          <div className="form-group">
            <label>Email Address</label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              placeholder="you@example.com"
              required
              autoFocus
            />
          </div>

          {error && <div className="error-message">{error}</div>}

          <button type="submit" disabled={loading}>
            {loading ? 'Sending...' : 'Send Reset Link'}
          </button>
        </form>

        <div className="auth-links">
          <Link to="/login">‚Üê Back to Login</Link>
        </div>
      </div>
    </div>
  );
}
```

---

## Step 9: Frontend - Reset Password Page

**Create: `client/src/pages/ResetPassword.tsx`**

```tsx
// client/src/pages/ResetPassword.tsx
import { useState, useEffect } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';

export default function ResetPassword() {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const token = searchParams.get('token');

  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState(false);

  useEffect(() => {
    if (!token) {
      setError('Invalid reset link');
    }
  }, [token]);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError('');

    if (password !== confirmPassword) {
      setError('Passwords do not match');
      return;
    }

    if (password.length < 8) {
      setError('Password must be at least 8 characters');
      return;
    }

    setLoading(true);

    try {
      const response = await fetch('/api/auth/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token, password })
      });

      const data = await response.json();

      if (response.ok) {
        setSuccess(true);
        setTimeout(() => {
          navigate('/login');
        }, 3000);
      } else {
        setError(data.error || 'Failed to reset password');
      }
    } catch (err) {
      setError('Network error. Please try again.');
    } finally {
      setLoading(false);
    }
  }

  if (success) {
    return (
      <div className="reset-password-page">
        <div className="success-message">
          <h1>‚úÖ Password Reset!</h1>
          <p>Your password has been successfully reset.</p>
          <p>Redirecting to login...</p>
        </div>
      </div>
    );
  }

  if (!token) {
    return (
      <div className="reset-password-page">
        <div className="error-message">
          <h1>‚ùå Invalid Link</h1>
          <p>This password reset link is invalid.</p>
          <a href="/forgot-password">Request a new link</a>
        </div>
      </div>
    );
  }

  return (
    <div className="reset-password-page">
      <div className="reset-password-container">
        <h1>Set New Password</h1>

        <form onSubmit={handleSubmit}>
          <div className="form-group">
            <label>New Password</label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="At least 8 characters"
              required
              autoFocus
            />
          </div>

          <div className="form-group">
            <label>Confirm Password</label>
            <input
              type="password"
              value={confirmPassword}
              onChange={(e) => setConfirmPassword(e.target.value)}
              placeholder="Re-enter password"
              required
            />
          </div>

          {error && <div className="error-message">{error}</div>}

          <button type="submit" disabled={loading}>
            {loading ? 'Resetting...' : 'Reset Password'}
          </button>
        </form>
      </div>
    </div>
  );
}
```

---

## Step 10: Add "Forgot Password" Link to Login

**Update your Login page:**

```tsx
// In Login.tsx
<form onSubmit={handleLogin}>
  {/* ... email and password inputs ... */}
  
  <div className="auth-links">
    <a href="/forgot-password">Forgot Password?</a>
  </div>
  
  <button type="submit">Sign In</button>
</form>
```

---

## Step 11: Add Routes to App

**In `App.tsx`:**

```tsx
import ForgotPassword from './pages/ForgotPassword';
import ResetPassword from './pages/ResetPassword';

<Routes>
  <Route path="/login" element={<Login />} />
  <Route path="/forgot-password" element={<ForgotPassword />} />
  <Route path="/reset-password" element={<ResetPassword />} />
  {/* ... other routes ... */}
</Routes>
```

---

## Step 12: Test the Flow

### Test 1: Forgot Password
1. Go to `/forgot-password`
2. Enter a valid email
3. Click "Send Reset Link"
4. Check your email (the one in the database)
5. You should receive password reset email

### Test 2: Reset Password
1. Click the link in the email
2. Should go to `/reset-password?token=...`
3. Enter new password
4. Click "Reset Password"
5. Should redirect to login
6. Login with new password

### Test 3: Expired Token
1. Wait 1 hour (or manually set `resetTokenExpiry` to past date)
2. Try using the reset link
3. Should show "Invalid or expired token"

---

## Environment Variables Checklist

Make sure these are set in Replit Secrets:

```
RESEND_API_KEY=re_your_api_key_here
EMAIL_FROM=noreply@riselocal.app (or onboarding@resend.dev for testing)
FRONTEND_URL=https://riselocal.app (or your Replit URL for testing)
```

---

## Bonus: Send Batch Emails to 256 Users

**Once everything works, send recovery emails to users without passwords:**

```typescript
// scripts/sendRecoveryEmails.ts
import { db } from '../server/config/database';
import { sendEmail, generateAccountRecoveryEmail } from '../server/utils/email';

async function sendRecoveryEmails() {
  // Get all users without passwords
  const result = await db.query(
    'SELECT id, email, firstName FROM users WHERE password IS NULL ORDER BY createdAt'
  );

  console.log(`Found ${result.rows.length} users without passwords`);

  for (const user of result.rows) {
    try {
      const emailHtml = generateAccountRecoveryEmail(user.firstName, user.email);
      
      await sendEmail({
        to: user.email,
        subject: 'Welcome Back to Rise Local - Set Up Your Password',
        html: emailHtml
      });

      console.log(`‚úÖ Sent to ${user.email}`);
      
      // Wait 1 second between emails to avoid rate limits
      await new Promise(resolve => setTimeout(resolve, 1000));
      
    } catch (error) {
      console.error(`‚ùå Failed to send to ${user.email}:`, error);
    }
  }

  console.log('Done!');
}

sendRecoveryEmails();
```

**Run with:**
```bash
npx tsx scripts/sendRecoveryEmails.ts
```

---

## Troubleshooting

### Email not sending?

**Check console logs:**
```typescript
const result = await sendEmail({...});
console.log('Email result:', result);
```

**Common issues:**
- API key not set correctly
- Domain not verified (use `onboarding@resend.dev` for testing)
- Email address is invalid
- Resend rate limit hit (100 emails/day on free plan)

### Reset link not working?

**Check:**
- Token is being saved to database
- Token hasn't expired (check `resetTokenExpiry`)
- Frontend URL is correct in environment variables

### Domain verification taking too long?

Use `onboarding@resend.dev` for now, verify domain later.

---

## Summary

**What you've set up:**
1. ‚úÖ Resend account connected
2. ‚úÖ API key in environment
3. ‚úÖ Email utility with templates
4. ‚úÖ Forgot password endpoint
5. ‚úÖ Reset password endpoint
6. ‚úÖ Frontend pages for both flows
7. ‚úÖ Database columns for tokens
8. ‚úÖ Beautiful HTML email templates

**Users can now:**
- Request password reset via email
- Click link to reset password
- Set new password securely
- Login with new credentials

**Next:**
- Test the complete flow
- Verify domain in Resend
- Send batch emails to 256 users
- Monitor email delivery

You're ready to launch! üöÄ