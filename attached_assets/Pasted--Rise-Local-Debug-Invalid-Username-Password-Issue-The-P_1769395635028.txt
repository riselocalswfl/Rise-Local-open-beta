# Rise Local: Debug "Invalid Username/Password" Issue

## The Problem

Database shows correct email and password hash, but login says "invalid credentials."

---

## REPLIT AGENT: Debug Login Issues - Step by Step

### Step 1: Verify What's in the Database

Run this query and show me the results:

```sql
-- Check a specific user (replace with the email you're testing)
SELECT 
  id,
  email,
  password,
  LENGTH(password) as password_length,
  password IS NULL as is_null,
  isActive,
  lockedUntil,
  failedLoginAttempts
FROM users 
WHERE LOWER(email) = LOWER('YOUR_TEST_EMAIL_HERE');
```

**What I need to see:**
- Does `password` have a value (not NULL)?
- What is `password_length`? (should be 60 for bcrypt)
- Is `isActive` true?
- Is `lockedUntil` NULL?

---

### Step 2: Test Password Hashing

Create a test script to verify bcrypt is working:

```javascript
// test-password.js
const bcrypt = require('bcrypt');

async function testPassword() {
  const plainPassword = 'YOUR_TEST_PASSWORD_HERE'; // The password you're trying to login with
  const storedHash = 'PASTE_HASH_FROM_DATABASE_HERE'; // From the query above
  
  console.log('Testing password comparison...');
  console.log('Plain password:', plainPassword);
  console.log('Stored hash:', storedHash);
  console.log('Hash length:', storedHash ? storedHash.length : 'NULL');
  
  try {
    const isMatch = await bcrypt.compare(plainPassword, storedHash);
    console.log('Password match:', isMatch);
    
    if (!isMatch) {
      console.log('❌ Password does NOT match hash');
      console.log('This means:');
      console.log('  1. Wrong password being entered, OR');
      console.log('  2. Hash in database is corrupted, OR');
      console.log('  3. Hash was created with different salt rounds');
    } else {
      console.log('✅ Password DOES match hash');
      console.log('Problem is NOT with password hashing');
    }
  } catch (error) {
    console.error('❌ Bcrypt comparison failed:', error);
  }
  
  // Also test creating a new hash
  console.log('\nCreating new hash from same password...');
  const newHash = await bcrypt.hash(plainPassword, 10);
  console.log('New hash:', newHash);
  console.log('New hash length:', newHash.length);
  
  const newMatch = await bcrypt.compare(plainPassword, newHash);
  console.log('New hash works:', newMatch);
}

testPassword();
```

**Run this script:**
```bash
node test-password.js
```

---

### Step 3: Add Debug Logging to Login Endpoint

Temporarily add detailed logging to your login endpoint:

```javascript
// In your /api/auth/login endpoint

async function login(req, res) {
  const { email, password } = req.body;

  console.log('=== LOGIN ATTEMPT ===');
  console.log('Email received:', email);
  console.log('Password received:', password ? `[${password.length} chars]` : 'NULL');

  try {
    // Find user
    const userResult = await db.query(
      'SELECT * FROM users WHERE LOWER(email) = LOWER($1)',
      [email.trim()]
    );

    console.log('Database query executed');
    console.log('Users found:', userResult.rows.length);

    if (userResult.rows.length === 0) {
      console.log('❌ NO USER FOUND with email:', email);
      return res.status(401).json({
        error: 'Invalid email or password',
        code: 'INVALID_CREDENTIALS'
      });
    }

    const user = userResult.rows[0];
    
    console.log('User found:', {
      id: user.id,
      email: user.email,
      hasPassword: user.password ? 'YES' : 'NO',
      passwordLength: user.password ? user.password.length : 0,
      isActive: user.isActive,
      lockedUntil: user.lockedUntil
    });

    // Check if user has no password (needs recovery)
    if (!user.password) {
      console.log('⚠️ User has NO PASSWORD - needs recovery');
      return res.status(200).json({
        needsRecovery: true,
        email: user.email,
        firstName: user.firstName,
        message: 'Please set a password for your account',
        code: 'NEEDS_RECOVERY'
      });
    }

    // Check if account is locked
    if (user.lockedUntil && new Date(user.lockedUntil) > new Date()) {
      console.log('❌ Account is LOCKED until:', user.lockedUntil);
      return res.status(423).json({
        error: 'Account is locked',
        code: 'ACCOUNT_LOCKED'
      });
    }

    // Verify password
    console.log('Attempting bcrypt.compare...');
    console.log('  Plain password length:', password.length);
    console.log('  Hash length:', user.password.length);
    
    const validPassword = await bcrypt.compare(password, user.password);
    
    console.log('Bcrypt comparison result:', validPassword);

    if (!validPassword) {
      console.log('❌ PASSWORD DOES NOT MATCH');
      console.log('  User entered:', password);
      console.log('  Hash in DB:', user.password);
      
      // Increment failed attempts
      const newFailedAttempts = user.failedLoginAttempts + 1;
      await db.query(
        'UPDATE users SET failedLoginAttempts = $1 WHERE id = $2',
        [newFailedAttempts, user.id]
      );

      return res.status(401).json({
        error: 'Invalid email or password',
        code: 'INVALID_CREDENTIALS'
      });
    }

    console.log('✅ PASSWORD MATCHES');
    console.log('Generating token...');

    // Success - continue with token generation
    // ... rest of your code
    
  } catch (error) {
    console.error('❌ LOGIN ERROR:', error);
    console.error('Stack:', error.stack);
    res.status(500).json({
      error: 'Login failed',
      code: 'SERVER_ERROR'
    });
  }
}
```

**ACTION:** Add this logging, then try to login and paste the console output here.

---

### Step 4: Check Password Hash Format

The hash in your database should look like this:

```
$2b$10$abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ
```

**It must start with:** `$2a$`, `$2b$`, or `$2y$`

If it doesn't, the hash is invalid.

**Run this check:**

```sql
SELECT 
  email,
  SUBSTRING(password, 1, 4) as hash_prefix,
  password LIKE '$2%' as is_bcrypt_hash,
  LENGTH(password) as hash_length
FROM users 
WHERE email = 'YOUR_TEST_EMAIL_HERE';
```

**Expected results:**
- `hash_prefix` should be `$2a$`, `$2b$`, or `$2y$`
- `is_bcrypt_hash` should be `true`
- `hash_length` should be `60`

---

### Step 5: Check if Password was Set Correctly

If the user went through the recovery flow, verify the password was saved correctly:

```sql
-- Check when password was last updated
SELECT 
  email,
  password IS NOT NULL as has_password,
  updatedAt,
  createdAt
FROM users 
WHERE email = 'YOUR_TEST_EMAIL_HERE';
```

**Also check if there's a recovery log:**

```sql
SELECT * FROM account_recovery_log 
WHERE email = 'YOUR_TEST_EMAIL_HERE'
ORDER BY timestamp DESC 
LIMIT 5;
```

---

### Step 6: Manual Password Reset Test

Let's manually set a known password and test:

```javascript
// reset-password.js
const bcrypt = require('bcrypt');
const { Pool } = require('pg');

const pool = new Pool({
  connectionString: process.env.DATABASE_URL
});

async function resetPassword() {
  const email = 'YOUR_TEST_EMAIL_HERE';
  const newPassword = 'TestPassword123'; // Use this to login
  
  console.log('Hashing password...');
  const hash = await bcrypt.hash(newPassword, 10);
  
  console.log('Password hash created:', hash);
  console.log('Hash length:', hash.length);
  
  console.log('Updating database...');
  const result = await pool.query(
    'UPDATE users SET password = $1, updatedAt = NOW() WHERE LOWER(email) = LOWER($2) RETURNING id, email',
    [hash, email]
  );
  
  if (result.rows.length > 0) {
    console.log('✅ Password updated for:', result.rows[0].email);
    console.log('Try logging in with:');
    console.log('  Email:', email);
    console.log('  Password: TestPassword123');
  } else {
    console.log('❌ No user found with email:', email);
  }
  
  await pool.end();
}

resetPassword();
```

**Run this:**
```bash
node reset-password.js
```

Then try logging in with `TestPassword123`

---

### Step 7: Check for Email Case Sensitivity Issues

```sql
-- Check if there are multiple users with similar emails
SELECT id, email, password IS NOT NULL as has_password
FROM users 
WHERE email ILIKE '%your_email_here%';
```

Also check your login query:

```javascript
// Make sure you're using LOWER() or ILIKE for case-insensitive matching
const userResult = await db.query(
  'SELECT * FROM users WHERE LOWER(email) = LOWER($1)', // ✅ GOOD
  [email.trim()]
);

// NOT this:
// 'SELECT * FROM users WHERE email = $1' // ❌ BAD - case sensitive
```

---

### Step 8: Check Frontend is Sending Correct Data

Add console.log in your frontend login:

```javascript
// In Login.jsx
async function handleSubmit(e) {
  e.preventDefault();
  
  console.log('=== FRONTEND LOGIN ===');
  console.log('Email being sent:', email);
  console.log('Password being sent:', password);
  console.log('Email length:', email.length);
  console.log('Password length:', password.length);
  
  const response = await fetch('/api/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password })
  });
  
  console.log('Response status:', response.status);
  
  const data = await response.json();
  console.log('Response data:', data);
  
  // ... rest of code
}
```

---

## Common Issues & Solutions

### Issue 1: Password is NULL in Database

**Symptom:** User has `password = NULL`
**Solution:** User needs to go through recovery flow first

**Check:**
```sql
SELECT email, password IS NULL as no_password 
FROM users 
WHERE email = 'test@email.com';
```

If `no_password = true`, user must recover account first.

---

### Issue 2: Password Hash is Corrupted

**Symptom:** Hash doesn't start with `$2a$`, `$2b$`, or `$2y$`
**Solution:** Recreate hash using Step 6 above

**Check:**
```sql
SELECT email, SUBSTRING(password, 1, 4) as prefix 
FROM users 
WHERE email = 'test@email.com';
```

If prefix is not `$2a$`, `$2b$`, or `$2y$`, hash is invalid.

---

### Issue 3: Wrong bcrypt Version

**Symptom:** Hash starts with `$2a$` but bcrypt.compare fails
**Solution:** Ensure bcrypt package is installed correctly

**Check:**
```bash
npm list bcrypt
```

Should show `bcrypt@5.x.x` or similar.

If it shows `bcryptjs`, that could be the issue. Use `bcrypt` not `bcryptjs`.

---

### Issue 4: Email Has Extra Spaces

**Symptom:** Email looks correct but login fails
**Solution:** Trim email on both frontend and backend

**Check:**
```javascript
// Frontend
const trimmedEmail = email.trim();

// Backend
const userResult = await db.query(
  'SELECT * FROM users WHERE LOWER(email) = LOWER($1)',
  [email.trim()] // ← Add .trim()
);
```

---

### Issue 5: Password Has Invisible Characters

**Symptom:** Password looks right but doesn't match
**Solution:** Check for copy-paste issues

**Test:**
```javascript
console.log('Password bytes:', Buffer.from(password).toString('hex'));
```

Should only show normal ASCII characters.

---

## Debugging Checklist

Run through these in order:

- [ ] Step 1: Check database - does user exist, does password exist, what's the hash?
- [ ] Step 2: Test bcrypt - does the password match the hash?
- [ ] Step 3: Add logging to login endpoint - what's happening in the code?
- [ ] Step 4: Check hash format - does it start with `$2a$`/`$2b$`/`$2y$`?
- [ ] Step 5: Check when password was set - was it set correctly?
- [ ] Step 6: Manual password reset - set a known password and test
- [ ] Step 7: Check email case - is query case-insensitive?
- [ ] Step 8: Check frontend - is it sending the right data?

---

## What to Report Back

After running the above steps, report:

1. **From Step 1 (Database check):**
   - Does user exist?
   - Is password NULL or has a value?
   - What's the password length?

2. **From Step 2 (Bcrypt test):**
   - Does `bcrypt.compare()` return true or false?

3. **From Step 3 (Login logging):**
   - Paste the console output from a login attempt

4. **From Step 4 (Hash format):**
   - What does the hash start with?

5. **From Step 6 (Manual reset):**
   - After manual reset, can you login?

With this info, I can pinpoint the exact issue!

---

## Quick Fix to Try Right Now

If you want to try something immediately:

```javascript
// In your recovery endpoint or wherever password is set:

// ❌ WRONG: Missing await
const hash = bcrypt.hash(password, 10);

// ✅ CORRECT: With await
const hash = await bcrypt.hash(password, 10);

// ❌ WRONG: Wrong parameter order
const hash = await bcrypt.hash(10, password);

// ✅ CORRECT: Right parameter order
const hash = await bcrypt.hash(password, 10);
```

Check your password hashing code for these issues!