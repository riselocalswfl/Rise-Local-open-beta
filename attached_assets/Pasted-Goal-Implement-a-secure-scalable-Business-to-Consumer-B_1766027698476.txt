Goal: Implement a secure, scalable Business-to-Consumer (B2C) messaging system for Rise Local using the messaging structure that already exists, without rebuilding or breaking current chat logic. This feature is a premium / pass-locked feature for businesses.

â¸»

ğŸ”’ Core Rules (Do NOT Ignore)
	1.	Reuse existing messaging tables, routes, and socket/event logic already in the codebase.
	2.	Do not create parallel chat systems.
	3.	Extend the current message model to support:
	â€¢	Consumer â†’ Business messages
	â€¢	Business â†’ Consumer replies
	4.	All messaging must be:
	â€¢	Auth-protected
	â€¢	Role-aware
	â€¢	Vendor-owned

â¸»

ğŸ§± Data Model (Extend, Donâ€™t Replace)

If these already exist, extend them:

conversations
	â€¢	id (uuid)
	â€¢	consumerId â†’ users.id
	â€¢	vendorId â†’ vendors.id
	â€¢	dealId nullable (optional context)
	â€¢	lastMessageAt
	â€¢	createdAt

Rules:
	â€¢	One active conversation per consumer + vendor (+ deal optional)
	â€¢	Prevent duplicates

messages
	â€¢	id
	â€¢	conversationId
	â€¢	senderId â†’ users.id
	â€¢	senderRole enum: consumer | vendor
	â€¢	content (text)
	â€¢	isRead boolean default false
	â€¢	createdAt

â¸»

ğŸ” Access & Permissions
	â€¢	Consumers:
	â€¢	Can message a business only from a Deal page or Business profile
	â€¢	Can only see their own conversations
	â€¢	Businesses:
	â€¢	Can only message consumers who initiated contact
	â€¢	Can only view conversations tied to their vendorId
	â€¢	Admins:
	â€¢	Read-only access

â¸»

ğŸ’¬ API Endpoints (Extend Existing Ones)

Use existing route files where messaging already lives.

Conversations
	â€¢	GET /api/messages/conversations
	â€¢	Returns conversations scoped to user role

Messages
	â€¢	GET /api/messages/:conversationId
	â€¢	Returns messages sorted by createdAt ASC
	â€¢	Marks messages as read when opened
	â€¢	POST /api/messages/:conversationId
	â€¢	Body: { content: string }
	â€¢	Automatically sets senderRole based on user.role
	â€¢	Updates lastMessageAt

Conversation Creation
	â€¢	POST /api/messages/start
	â€¢	Body: { vendorId, dealId? }
	â€¢	Creates conversation if one doesnâ€™t exist
	â€¢	Returns conversationId

â¸»

ğŸ”” Notifications (Critical)

When a message is sent:
	1.	Trigger in-app notification for recipient
	2.	Trigger email notification if recipient is offline
	â€¢	Businesses receive: â€œNew customer message on Rise Localâ€
	â€¢	Consumers receive: â€œNew reply from [Business Name]â€

Reuse existing notification/email infrastructure if present.

â¸»

ğŸ’ Premium Logic
	â€¢	Business-to-consumer messaging is:
	â€¢	Free for consumers
	â€¢	Locked for businesses unless subscribed
	â€¢	If business is not subscribed:
	â€¢	Show messages as read-only
	â€¢	Prompt upgrade CTA
	â€¢	Admin bypass allowed

â¸»

ğŸ“± Frontend Integration Notes
	â€¢	Consumer entry points:
	â€¢	â€œMessage Businessâ€ button on:
	â€¢	Deal page
	â€¢	Business profile
	â€¢	Business entry point:
	â€¢	Messages tab inside My Account â†’ Vendor Dashboard
	â€¢	Unread badge count on tab bar
	â€¢	Optimized for mobile (no desktop-only layouts)

â¸»

ğŸ§ª Safety & Edge Cases
	â€¢	Block empty messages
	â€¢	Rate-limit messages per minute
	â€¢	Prevent cross-vendor access
	â€¢	Soft-delete conversations when vendor is deactivated
	â€¢	Never hard-delete messages

â¸»

âœ… Deliverables
	â€¢	Extended schema (only if needed)
	â€¢	Updated message routes
	â€¢	Notification triggers
	â€¢	Permission guards
	â€¢	Seed test conversation
	â€¢	Clear comments explaining what was reused vs added

Implement using the existing messaging system. Do not rebuild. Do not duplicate. Do not break current functionality.