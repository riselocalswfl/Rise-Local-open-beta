
54
55
56
57
58
59
CREATE TABLE IF NOT EXISTS migration_log (
  id SERIAL PRIMARY KEY,
  user_id VARCHAR REFERENCES users(id) ON DELETE CASCADE,
  action VARCHAR(100) NOT NULL,
  success BOOLEAN NOT NULL,
  notes TEXT,
  ip_address VARCHAR(45),
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS migration_log_user_idx ON migration_log(user_id);
CREATE INDEX IF NOT EXISTS migration_log_timestamp_idx ON migration_log(created_at);

-- Create temp_tokens table
CREATE TABLE IF NOT EXISTS temp_tokens (
  id SERIAL PRIMARY KEY,
  token VARCHAR(255) NOT NULL UNIQUE,
  user_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  purpose VARCHAR(50) NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  used BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS temp_token_idx ON temp_tokens(token);
CREATE INDEX IF NOT EXISTS temp_token_user_idx ON temp_tokens(user_id);
CREATE INDEX IF NOT EXISTS temp_token_expiry_idx ON temp_tokens(expires_at);

-- Mark existing OAuth users for migration (users with no password)
UPDATE users SET migration_required = true 
WHERE password IS NULL AND id IS NOT NULL;
ALTER TABLE users ADD COLUMN IF NOT EXISTS migration_required BOOLEAN DEFAULT false;
ALTER TABLE users ADD COLUMN IF NOT EXISTS migrated_at TIMESTAMP;
CREATE TABLE IF NOT EXISTS migration_log (
  id SERIAL PRIMARY KEY,
  user_id VARCHAR REFERENCES users(id) ON DELETE CASCADE,
  action VARCHAR(100) NOT NULL,
  success BOOLEAN NOT NULL,
  notes TEXT,
  ip_address VARCHAR(45),
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE IF NOT EXISTS temp_tokens (
  id SERIAL PRIMARY KEY,
  token VARCHAR(255) NOT NULL UNIQUE,
  user_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  purpose VARCHAR(50) NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  used BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
UPDATE users SET migration_required = true WHERE password IS NULL;



0 rows â€¢ 75ms

